name: Create new cohort

on:
  issues:
    types: labeled

env:
  GH_TOKEN: ${{ secrets.GH_PAT }}

jobs:

  parse_issue:
    if: ${{ github.event.label.name == 'cohort' }}
    name: Parse Issue data
    runs-on: ubuntu-latest
    outputs:
      org: ${{ steps.extract.outputs.org }}
      lesson_repo: ${{ steps.extract.outputs.repo }}
      assignments: ${{ steps.extract.outputs.assignments }}
      instructors: ${{ steps.extract.outputs.instructors }}
      students: ${{ steps.extract.outputs.students }}
    steps:
      - name: Parse issue
        id: parse
        uses: zentered/issue-forms-body-parser@v2.1.1
      - name: Extract relevant fields
        id: extract
        run: |
          echo "org=$(echo $ISSUE_DATA | jq -r '."organization-name".content|.[]')" >> $GITHUB_OUTPUT
          echo "repo=$(echo $ISSUE_DATA | jq -r '."lesson-repository".content|.[]')" >> $GITHUB_OUTPUT
          # Using sed to format output as an array
          echo "assignments=$(echo $ISSUE_DATA | jq -c '."list-of-assignments".content' | sed 's/\\r\\n/", "/g')" >> $GITHUB_OUTPUT
          echo "instructors=$(echo $ISSUE_DATA | jq -c '."list-of-instructors".content' | sed -e 's/\\r\\n/ /g' -e 's/[^[:alnum:] @.-]//g')" >> $GITHUB_OUTPUT
          echo "students=$(echo $ISSUE_DATA | jq -c '."list-of-students".content' | sed -e 's/\\r\\n/ /g' -e 's/[^[:alnum:] @.-]//g')" >> $GITHUB_OUTPUT
        env:
          ISSUE_DATA: ${{ steps.parse.outputs.data }}
      - name: Show output
        run: |
          echo ${{ toJson(steps.parse.outputs.data) }} >> "parse_data.json"
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: parse-data
          path: parse_data.json

  create_lesson_repo:
    name: Fork lesson repo
    needs: parse_issue
    runs-on: ubuntu-latest
    env:
      ORG: ${{ needs.parse_issue.outputs.org }}
      REPO: ${{ needs.parse_issue.outputs.lesson_repo }}
    steps:
      - name: Fork lesson repo
        if: env.REPO != '*No response*'
        run: |
          gh repo fork ${{ github.repository_owner }}/${{ env.REPO }} --org ${{ env.ORG }}

  create_assignment_repos:
    name: Fork assignment repos
    needs: parse_issue
    runs-on: ubuntu-latest
    env:
      ORG: ${{ needs.parse_issue.outputs.org }}
    strategy:
      matrix:
        repos: ${{ fromJson(needs.parse_issue.outputs.assignments) }}
    steps:
      - name: Fork assignment repos
        if: matrix.repos != '*No response*'
        run: |
          gh repo fork ${{ github.repository_owner }}/${{ matrix.repos }} --org ${{ env.ORG }}
  invite_members:
    name: Invite students and instructors to org
    needs: parse_issue
    runs-on: ubuntu-latest
    env:
      ORG: ${{ needs.parse_issue.outputs.org }}
    steps:
      - name: Invite instructors
        if: needs.parse_issue.outputs.instructors != '*No response*'
        run: |
          for instructor in $(echo ${{ needs.parse_issue.outputs.instructors }}); do
            gh api -X POST /orgs/${{ env.ORG }}/invitations --input <(echo '{"email": '${instructor}', "role": "admin"}')
          done
      - name: Invite students
        if: needs.parse_issue.outputs.students != '*No response*'
        run: |
          for student in $(echo ${{ needs.parse_issue.outputs.students }}); do
            gh api -X POST /orgs/${{ env.ORG }}/invitations --input <(echo '{"email": '{$student}', "role": "direct_member"}')
          done
